<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Foods - TasteNow</title>
    
    <link rel="stylesheet" href="../../assets/css/base.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/pages.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="../../index.html" class="navbar-brand">
                <i class="fas fa-utensils"></i>
                TasteNow
            </a>

            <button class="navbar-toggle" id="navbarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="navbar-menu" id="navbarMenu">
                <a href="../../index.html" class="navbar-link">Home</a>
                <a href="restaurants.html" class="navbar-link">Restaurants</a>
                <a href="foods.html" class="navbar-link active">Foods</a>
            </div>

            <div class="navbar-actions">
                <a href="cart.html" class="navbar-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="navbar-badge" id="cartBadge">0</span>
                </a>
                <a href="order-history.html" class="navbar-icon" id="ordersIcon" style="display: none;">
                    <i class="fas fa-receipt"></i>
                </a>
                <div id="authLinks">
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Page Header -->
    <section class="section" style="background: linear-gradient(135deg, var(--primary-color) 0%, #e85d75 100%); color: var(--white);">
        <div class="container">
            <h1 style="font-size: 2.5rem; color: var(--white); margin-bottom: var(--spacing-md);">Browse All Foods</h1>
            <p style="font-size: 18px; margin-bottom: var(--spacing-lg);">Discover delicious dishes from all restaurants</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container" style="padding: var(--spacing-xl) 0;">
        <div class="layout-sidebar">
            <!-- Sidebar Filters -->
            <aside class="sidebar">
                <!-- Search -->
                <div class="mb-lg">
                    <h4 class="mb-md">Search Foods</h4>
                    <input type="text" class="form-control" placeholder="Search by name..." id="searchInput" style="width: 100%;">
                </div>

                <!-- Price Range Filter -->
                <div class="mb-lg" style="padding-bottom: var(--spacing-lg); border-bottom: 1px solid var(--gray);">
                    <h4 class="mb-md">Price Range</h4>
                    <div class="mb-md">
                        <input type="range" min="0" max="50" value="50" id="priceRange" style="width: 100%;" oninput="updatePriceFilter(this.value)">
                    </div>
                    <p style="font-size: 14px; color: var(--medium-gray);">
                        Max Price: <span id="priceValue">$50</span>
                    </p>
                </div>

                <!-- Category Filter -->
                <div class="mb-lg" style="padding-bottom: var(--spacing-lg); border-bottom: 1px solid var(--gray);">
                    <h4 class="mb-md">Category</h4>
                    <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);" id="categoryFilterContainer">
                        <!-- Categories will be loaded dynamically -->
                        <p style="color: var(--medium-gray);">Loading categories...</p>
                    </div>
                </div>

                <!-- Dietary Preferences -->
                <div class="mb-lg" style="padding-bottom: var(--spacing-lg); border-bottom: 1px solid var(--gray);">
                    <h4 class="mb-md">Dietary</h4>
                    <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        <label class="form-checkbox">
                            <input type="checkbox" class="dietaryFilter" value="true" onchange="filterByDietary()">
                            <span>Vegetarian</span>
                        </label>
                        <label class="form-checkbox">
                            <input type="checkbox" class="dietaryFilter" value="false" onchange="filterByDietary()">
                            <span>Non-Vegetarian</span>
                        </label>
                    </div>
                </div>

                <!-- Clear Filters -->
                <button class="btn btn-outline btn-block" onclick="clearAllFilters()">Clear All Filters</button>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Search & Sort Bar -->
                <div class="card mb-lg">
                    <div class="card-body" style="padding: var(--spacing-md);">
                        <div class="d-flex gap-md align-center">
                            <div style="flex: 1;">
                                <input type="text" class="form-control" placeholder="Search foods..." id="searchInputTop">
                            </div>
                            <select class="form-control" style="max-width: 200px;" id="sortBy" onchange="sortFoods(this.value)">
                                <option value="popular">Sort by: Popular</option>
                                <option value="price-low">Sort by: Price (Low - High)</option>
                                <option value="price-high">Sort by: Price (High - Low)</option>
                                <option value="newest">Sort by: Newest</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" style="text-align: center; padding: var(--spacing-xl); display: none;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <p style="margin-top: var(--spacing-md); color: var(--medium-gray);">Loading foods...</p>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" style="display: none;">
                    <div class="card" style="background-color: #fee; border: 1px solid #fcc;">
                        <div class="card-body">
                            <p id="errorText" style="color: #c33; margin: 0;"></p>
                        </div>
                    </div>
                </div>

                <!-- Results Count -->
                <div class="mb-lg">
                    <p style="color: var(--medium-gray);">Showing <span id="resultCount">0</span> items</p>
                </div>

                <!-- Foods Grid -->
                <div class="grid grid-4" id="foodsGrid"></div>
                    <!-- Food items will be dynamically populated -->
                </div>

                <!-- No Results Message -->
                <div id="noResults" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <i class="fas fa-search" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: var(--spacing-md);"></i>
                    <h3 style="color: var(--medium-gray);">No foods found</h3>
                    <p style="color: var(--medium-gray);">Try adjusting your filters or search criteria</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TasteNow</h3>
                    <p>Your local food ordering platform. Supporting local restaurants and connecting hungry customers.</p>
                </div>

                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="../../index.html">Home</a>
                    <a href="restaurants.html">Restaurants</a>
                    <a href="foods.html">Foods</a>
                    <a href="about.html">About Us</a>
                    <a href="contact.html">Contact</a>
                </div>

                <div class="footer-section">
                    <h3>For Restaurants</h3>
                    <a href="#">Partner With Us</a>
                    <a href="#">Restaurant Dashboard</a>
                    <a href="#">Terms & Conditions</a>
                </div>

                <div class="footer-section">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> info@tastenow.com</p>
                    <p><i class="fas fa-phone"></i> +1 234 567 8900</p>
                    <p><i class="fas fa-map-marker-alt"></i> 123 Food Street, City</p>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2024 TasteNow. All rights reserved. | Developed by Kaoserahamed</p>
            </div>
        </div>
    </footer>

    <!-- Modal for Food Details -->
    <div class="modal" id="foodModal">
        <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalFoodName">Food Name</h2>
                    <button class="modal-close" onclick="closeModal('foodModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="modalFoodImage" src="" alt="Food" style="width: 100%; height: 300px; object-fit: cover; border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg);">
                    <div style="margin-bottom: var(--spacing-md);">
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Restaurant:</strong> <span id="modalRestaurant"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Category:</strong> <span id="modalCategory"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Price:</strong> <span id="modalPrice" class="fw-semibold" style="color: var(--primary-color); font-size: 18px;"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Type:</strong> <span id="modalType"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Prep Time:</strong> <span id="modalPrepTime"></span></p>
                    </div>
                    <p id="modalDescription" style="color: var(--dark-gray); line-height: 1.6; margin-bottom: var(--spacing-md);"></p>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                            <button class="btn btn-outline btn-sm" onclick="decreaseQty()">-</button>
                            <input type="number" id="modalQty" class="form-control" value="1" min="1" style="max-width: 80px; text-align: center;">
                            <button class="btn btn-outline btn-sm" onclick="increaseQty()">+</button>
                        </div>
                    </div>
                    <div class="form-actions" style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                        <button class="btn btn-primary btn-block" onclick="addToCart()">Add to Cart</button>
                        <button class="btn btn-outline btn-block" onclick="closeModal('foodModal')">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // API Configuration
        // ==========================================
        const API_BASE_URL = 'http://localhost:5000/api';

        // Global State
        let allMenuItems = [];
        let allRestaurants = {};
        let filteredData = [];
        let currentSort = 'popular';
        let selectedFood = null;

        // ==========================================
        // Initialize Page
        // ==========================================
        async function initPage() {
            try {
                showLoading(true);
                console.log('üîÑ Initializing page...');
                
                await loadRestaurants();
                await loadMenuItems();
                loadCategories();
                
                filteredData = [...allMenuItems];
                displayFoods();
                setupEventListeners();
                
                showLoading(false);
                console.log('‚úÖ Page initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing page:', error);
                showError('Failed to load foods. Please try again later.');
                showLoading(false);
            }
        }

        // ==========================================
        // Load Restaurants from Backend
        // ==========================================
        async function loadRestaurants() {
            try {
                console.log('üìç Loading restaurants from:', `${API_BASE_URL}/restaurants`);
                
                const response = await fetch(`${API_BASE_URL}/restaurants`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const restaurants = await response.json();
                
                if (Array.isArray(restaurants)) {
                    restaurants.forEach(restaurant => {
                        allRestaurants[restaurant.restaurant_id] = restaurant;
                    });
                    console.log('‚úÖ Restaurants loaded:', restaurants.length);
                } else {
                    console.warn('‚ö†Ô∏è Unexpected restaurants response format');
                }
            } catch (error) {
                console.error('‚ùå Error loading restaurants:', error);
            }
        }

        // ==========================================
        // Load Menu Items from Backend
        // ==========================================
        async function loadMenuItems() {
            try {
                console.log('üçΩÔ∏è Loading menu items from:', `${API_BASE_URL}/menu/items/public`);
                
                const response = await fetch(`${API_BASE_URL}/menu/items/public`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && Array.isArray(data.items)) {
                    allMenuItems = data.items;
                } else if (Array.isArray(data)) {
                    allMenuItems = data;
                } else {
                    console.warn('‚ö†Ô∏è Unexpected menu items response format:', data);
                    allMenuItems = [];
                }
                
                console.log('‚úÖ Menu items loaded:', allMenuItems.length);
            } catch (error) {
                console.error('‚ùå Error loading menu items:', error);
                showError('Failed to load menu items. Please refresh the page.');
                allMenuItems = [];
            }
        }

        // ==========================================
        // Display Foods Grid
        // ==========================================
        function displayFoods() {
            const grid = document.getElementById('foodsGrid');
            const noResults = document.getElementById('noResults');
            const resultCount = document.getElementById('resultCount');

            if (filteredData.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                resultCount.textContent = '0';
                return;
            }

            noResults.style.display = 'none';
            grid.innerHTML = '';
            resultCount.textContent = filteredData.length;

            filteredData.forEach(food => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                const imageUrl = food.image_url || 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(food.name);
                const restaurant = allRestaurants[food.restaurant_id];
                const restaurantName = restaurant?.name || 'Unknown Restaurant';
                const vegetarianStatus = food.is_vegetarian ? 'ü•¨ Veg' : 'üçó Non-Veg';
                const availabilityBadge = food.is_available ? '' : '<span class="badge" style="background-color: #FF8C00; color: white; margin-left: 4px;">Unavailable</span>';

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${food.name}" class="card-img" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <div class="card-body">
                        <h4 class="card-title" style="margin-bottom: 4px;">${food.name}</h4>
                        <p class="text-muted" style="font-size: 14px; margin-bottom: 8px;">${restaurantName}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span class="fw-semibold" style="color: var(--primary-color); font-size: 18px;">$${parseFloat(food.price).toFixed(2)}</span>
                        </div>
                        <span class="badge" style="background-color: ${food.is_vegetarian ? '#51CF66' : '#FF6B6B'}; color: white;">${vegetarianStatus}</span>
                        ${availabilityBadge}
                    </div>
                `;
                card.onclick = () => openFoodModal(food);
                grid.appendChild(card);
            });
        }

        // ==========================================
        // Event Listeners Setup
        // ==========================================
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('keyup', searchFoods);
            document.getElementById('searchInputTop').addEventListener('keyup', (e) => {
                document.getElementById('searchInput').value = e.target.value;
                searchFoods();
            });
        }

        // ==========================================
        // Load Categories from Menu Items
        // ==========================================
        function loadCategories() {
            const categories = new Set();
            allMenuItems.forEach(item => {
                if (item.category_name && item.category_name.trim()) {
                    categories.add(item.category_name);
                }
            });

            const container = document.getElementById('categoryFilterContainer');
            
            if (categories.size === 0) {
                container.innerHTML = '<p style="color: var(--medium-gray);">All items</p>';
                return;
            }

            container.innerHTML = '';
            Array.from(categories).sort().forEach(category => {
                const label = document.createElement('label');
                label.className = 'form-checkbox';
                label.innerHTML = `
                    <input type="checkbox" class="categoryFilter" value="${category}" onchange="filterByCategory()">
                    <span>${category}</span>
                `;
                container.appendChild(label);
            });

            console.log('‚úÖ Categories loaded:', categories.size);
        }

        // ==========================================
        // Search Foods
        // ==========================================
        function searchFoods() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            console.log('üîç Searching for:', term);
            applyAllFilters();
        }

        // ==========================================
        // Filter Functions
        // ==========================================
        function filterByCategory() {
            applyAllFilters();
        }

        function filterByDietary() {
            applyAllFilters();
        }

        function applyAllFilters() {
            let result = [...allMenuItems];

            // Search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                result = result.filter(food => 
                    food.name.toLowerCase().includes(searchTerm) || 
                    (food.category_name && food.category_name.toLowerCase().includes(searchTerm)) ||
                    (allRestaurants[food.restaurant_id]?.name || '').toLowerCase().includes(searchTerm)
                );
            }

            // Category filter
            const selectedCategories = Array.from(document.querySelectorAll('.categoryFilter:checked')).map(el => el.value);
            if (selectedCategories.length > 0) {
                result = result.filter(food => selectedCategories.includes(food.category_name));
            }

            // Dietary filter
            const selectedDietary = Array.from(document.querySelectorAll('.dietaryFilter:checked')).map(el => el.value);
            if (selectedDietary.length > 0) {
                result = result.filter(food => {
                    if (selectedDietary.includes('true')) {
                        if (food.is_vegetarian) return true;
                    }
                    if (selectedDietary.includes('false')) {
                        if (!food.is_vegetarian) return true;
                    }
                    return false;
                });
            }

            // Price filter
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            result = result.filter(food => parseFloat(food.price) <= maxPrice);

            filteredData = result;
            sortFoods(currentSort);
        }

        // ==========================================
        // Sort Foods
        // ==========================================
        function sortFoods(sortType) {
            currentSort = sortType;
            let sorted = [...filteredData];

            switch(sortType) {
                case 'price-low':
                    sorted.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                    break;
                case 'price-high':
                    sorted.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                    break;
                case 'newest':
                    sorted.reverse();
                    break;
                default:
                    // popular (original order)
            }

            filteredData = sorted;
            displayFoods();
        }

        // ==========================================
        // Filter Controls
        // ==========================================
        function updatePriceFilter(value) {
            document.getElementById('priceValue').textContent = '$' + value;
            applyAllFilters();
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInputTop').value = '';
            document.getElementById('priceRange').value = '50';
            document.getElementById('priceValue').textContent = '$50';
            document.querySelectorAll('.categoryFilter, .dietaryFilter').forEach(el => el.checked = false);
            filteredData = [...allMenuItems];
            displayFoods();
        }

        // ==========================================
        // Modal Functions
        // ==========================================
        function openFoodModal(food) {
            selectedFood = food;
            const restaurant = allRestaurants[food.restaurant_id] || {};

            document.getElementById('modalFoodName').textContent = food.name;
            document.getElementById('modalFoodImage').src = food.image_url || 'https://via.placeholder.com/500x300?text=' + encodeURIComponent(food.name);
            document.getElementById('modalRestaurant').textContent = restaurant.name || 'Unknown Restaurant';
            document.getElementById('modalCategory').textContent = food.category_name || 'Uncategorized';
            document.getElementById('modalPrice').textContent = '$' + parseFloat(food.price).toFixed(2);
            document.getElementById('modalType').textContent = food.is_vegetarian ? 'Vegetarian' : 'Non-Vegetarian';
            document.getElementById('modalPrepTime').textContent = (food.preparation_time || 15) + ' mins';
            document.getElementById('modalDescription').textContent = food.description || 'No description available';
            document.getElementById('modalQty').value = 1;

            openModal('foodModal');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
        }

        // ==========================================
        // Quantity Controls
        // ==========================================
        function increaseQty() {
            const input = document.getElementById('modalQty');
            input.value = parseInt(input.value) + 1;
        }

        function decreaseQty() {
            const input = document.getElementById('modalQty');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        // ==========================================
        // Add to Cart
        // ==========================================
        function addToCart() {
            if (!selectedFood) {
                alert('Error: Food item not found');
                return;
            }

            const foodName = document.getElementById('modalFoodName').textContent;
            const qty = parseInt(document.getElementById('modalQty').value);
            const foodImage = document.getElementById('modalFoodImage').src;
            const foodPrice = parseFloat(document.getElementById('modalPrice').textContent.replace('$', ''));
            const restaurantName = document.getElementById('modalRestaurant').textContent;

            // Use the correct ID field from database
            const foodId = selectedFood.item_id || selectedFood.menu_item_id || selectedFood.id;

            const cartItem = {
                id: foodId,
                name: foodName,
                price: foodPrice,
                quantity: qty,
                restaurant: restaurantName,
                restaurantId: selectedFood.restaurant_id,
                image: foodImage,
                description: selectedFood.description
            };

            // Load existing cart
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');

            // Check if item already exists
            const existingItem = cart.find(item => item.id === foodId);
            if (existingItem) {
                existingItem.quantity += qty;
            } else {
                cart.push(cartItem);
            }

            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();

            console.log('‚úÖ Added to cart:', cartItem);
            alert(`${foodName} x${qty} added to cart!`);
            closeModal('foodModal');
        }

        // ==========================================
        // UI Helpers
        // ==========================================
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
            }
        }

        // ==========================================
        // Event Listeners
        // ==========================================
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                e.target.classList.remove('active');
            }
        });

        document.getElementById('navbarToggle')?.addEventListener('click', () => {
            const menu = document.getElementById('navbarMenu');
            menu.classList.toggle('active');
        });

        // ==========================================
        // Initialize on Page Load
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initPage();
            updateCartBadge();
        });

        window.addEventListener('storage', updateCartBadge);
    </script>
    <script src="../../js/global-auth.js"></script>
</body>
</html>
