<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurants - TasteNow</title>

    <link rel="stylesheet" href="../../assets/css/base.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/pages.css">

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="../../index.html" class="navbar-brand">
                <i class="fas fa-utensils"></i>
                TasteNow
            </a>

            <button class="navbar-toggle" id="navbarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="navbar-menu" id="navbarMenu">
                <a href="../../index.html" class="navbar-link">Home</a>
                <a href="restaurants.html" class="navbar-link active">Restaurants</a>
                <a href="foods.html" class="navbar-link">Foods</a>
            </div>

            <div class="navbar-actions">
                <a href="cart.html" class="navbar-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="navbar-badge" id="cartBadge">0</span>
                </a>
                <a href="order-history.html" class="navbar-icon" id="ordersIcon" style="display: none;">
                    <i class="fas fa-receipt"></i>
                </a>
                <div id="authLinks">
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="container mt-xl mb-xl">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <div class="breadcrumb-item">
                <a href="../../index.html">Home</a>
            </div>
            <div class="breadcrumb-item">Restaurants</div>
        </div>

        <h1 class="mb-lg">All Restaurants</h1>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="filter-item">
                <input type="text" class="form-control" placeholder="Search restaurants..." id="searchInput">
            </div>

            <div class="filter-item">
                <select class="form-control" id="cuisineFilter">
                    <option value="">All Cuisines</option>
                    <!-- Dynamically populated -->
                </select>
            </div>

            <div class="filter-item">
                <select class="form-control" id="sortBy">
                    <option value="rating">Sort By: Rating (High to Low)</option>
                    <option value="name">Name (A-Z)</option>
                    <option value="delivery_time">Delivery Time (Fast)</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Apply Filters
            </button>
        </div>

        <!-- Restaurant Grid -->
        <div class="grid grid-3" id="restaurantsGrid">
            <!-- Loading state -->
            <div style="grid-column: 1/-1; text-align: center; padding: var(--spacing-xl);">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary-color);"></i>
                <p class="text-muted mt-md">Loading restaurants...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TasteNow</h3>
                    <p>Your local food ordering platform.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="../../index.html">Home</a>
                    <a href="restaurants.html">Restaurants</a>
                </div>
                <div class="footer-section">
                    <h3>For Restaurants</h3>
                    <a href="#">Partner With Us</a>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> info@tastenow.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TasteNow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../js/main.js"></script>
    <script>
        // Global variables
        let allRestaurants = [];
        let filteredRestaurants = [];
        let cuisineTypes = new Set();

        // API URL
        const API_URL = 'http://localhost:5000/api';

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadRestaurants();
            updateCartBadge();
            setupEventListeners();
        });

        // Load restaurants from backend
        async function loadRestaurants() {
            try {
                const response = await fetch(`${API_URL}/restaurants`);
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    allRestaurants = data.map(restaurant => ({
                        id: restaurant.restaurant_id,
                        name: restaurant.name,
                        description: restaurant.description,
                        cuisine: restaurant.cuisine_type,
                        rating: parseFloat(restaurant.rating) || 4.5,
                        totalReviews: restaurant.total_reviews || 0,
                        deliveryTime: restaurant.delivery_time || '30-40 min',
                        priceRange: restaurant.price_range || '$$',
                        image: restaurant.image_url && restaurant.image_url !== "null"
                            ? restaurant.image_url
                            : "https://images.unsplash.com/photo-1600891964599-f61ba0e24092?auto=format&fit=crop&w=400&h=300&q=80",

                        isOpen: restaurant.is_open,
                        address: restaurant.address,
                        phone: restaurant.phone
                    }));

                    // Extract unique cuisines
                    allRestaurants.forEach(r => {
                        if (r.cuisine) {
                            cuisineTypes.add(r.cuisine);
                        }
                    });

                    console.log('✅ Restaurants loaded:', allRestaurants.length);
                    populateCuisineFilter();
                    filteredRestaurants = [...allRestaurants];
                    displayRestaurants();
                } else {
                    throw new Error('Failed to load restaurants');
                }
            } catch (error) {
                console.error('❌ Error loading restaurants:', error);
                showError('Failed to load restaurants. Please try again later.');
            }
        }

        // Populate cuisine filter dropdown
        function populateCuisineFilter() {
            const cuisineFilter = document.getElementById('cuisineFilter');
            const sortedCuisines = Array.from(cuisineTypes).sort();

            sortedCuisines.forEach(cuisine => {
                const option = document.createElement('option');
                option.value = cuisine;
                option.textContent = cuisine;
                cuisineFilter.appendChild(option);
            });
        }

        // Display restaurants
        function displayRestaurants() {
            const grid = document.getElementById('restaurantsGrid');
            grid.innerHTML = '';

            if (filteredRestaurants.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: var(--spacing-xl);">
                        <i class="fas fa-search" style="font-size: 64px; color: var(--medium-gray); margin-bottom: var(--spacing-md);"></i>
                        <h3 style="color: var(--medium-gray);">No restaurants found</h3>
                        <p class="text-muted">Try adjusting your filters or search term</p>
                        <button class="btn btn-primary mt-md" onclick="resetFilters()">Reset Filters</button>
                    </div>
                `;
                return;
            }

            filteredRestaurants.forEach(restaurant => {
                const card = document.createElement('div');
                card.className = 'card restaurant-card';
                card.innerHTML = `
                    <div style="position: relative;">
                        <img src="${restaurant.image || 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(restaurant.name)}" 
                             alt="${restaurant.name}" 
                             class="card-img"
                             onerror="this.src='https://via.placeholder.com/400x300?text=Restaurant'">
                        <span class="restaurant-badge" style="background-color: ${restaurant.isOpen ? 'var(--success-color)' : 'var(--medium-gray)'}">
                            ${restaurant.isOpen ? 'Open Now' : 'Closed'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${restaurant.name}</h3>
                        <div class="rating mb-sm">
                            ${generateStarRating(restaurant.rating)}
                            <span class="text-muted">(${restaurant.rating.toFixed(1)})</span>
                        </div>
                        <p class="card-text">${restaurant.cuisine || 'Various Cuisines'}</p>
                        <p class="card-text text-muted" style="font-size: 14px; margin-top: 4px;">
                            <i class="fas fa-map-marker-alt"></i> ${truncateText(restaurant.address, 40)}
                        </p>
                        <div class="restaurant-meta">
                            <div class="restaurant-meta-item">
                                <i class="fas fa-clock"></i>
                                <span>${restaurant.deliveryTime}</span>
                            </div>
                            <div class="restaurant-meta-item">
                                <i class="fas fa-bangladeshi-taka-sign"></i>
                                <span>${restaurant.priceRange}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="menu.html?id=${restaurant.id}" class="btn ${restaurant.isOpen ? 'btn-primary' : 'btn-outline'} btn-block">
                            View Menu
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star rating-star"></i>';
            }

            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt rating-star"></i>';
            }

            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star rating-star"></i>';
            }

            return html;
        }

        // Truncate text
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cuisineFilter = document.getElementById('cuisineFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            // Filter
            filteredRestaurants = allRestaurants.filter(restaurant => {
                const matchesSearch = !searchTerm ||
                    restaurant.name.toLowerCase().includes(searchTerm) ||
                    restaurant.cuisine?.toLowerCase().includes(searchTerm) ||
                    restaurant.address?.toLowerCase().includes(searchTerm);

                const matchesCuisine = !cuisineFilter || restaurant.cuisine === cuisineFilter;

                return matchesSearch && matchesCuisine;
            });

            // Sort
            switch (sortBy) {
                case 'rating':
                    filteredRestaurants.sort((a, b) => b.rating - a.rating);
                    break;
                case 'name':
                    filteredRestaurants.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'delivery_time':
                    filteredRestaurants.sort((a, b) => {
                        const timeA = parseInt(a.deliveryTime.split('-')[0]);
                        const timeB = parseInt(b.deliveryTime.split('-')[0]);
                        return timeA - timeB;
                    });
                    break;
            }

            displayRestaurants();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('cuisineFilter').value = '';
            document.getElementById('sortBy').value = 'rating';
            filteredRestaurants = [...allRestaurants];
            displayRestaurants();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Real-time search
            document.getElementById('searchInput').addEventListener('input', applyFilters);

            // Filter changes
            document.getElementById('cuisineFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);

            // Enter key for search
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });

            // Navbar toggle
            document.getElementById('navbarToggle')?.addEventListener('click', () => {
                document.getElementById('navbarMenu').classList.toggle('active');
            });
        }

        // Show error message
        function showError(message) {
            const grid = document.getElementById('restaurantsGrid');
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: var(--spacing-xl);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--danger-color); margin-bottom: var(--spacing-md);"></i>
                    <h3 style="color: var(--danger-color);">Error Loading Restaurants</h3>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary mt-md" onclick="loadRestaurants()">
                        <i class="fas fa-sync"></i> Retry
                    </button>
                </div>
            `;
        }

        // Update cart badge
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
            }
        }

        // Update auth UI
        function updateAuthUI() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            const authLinks = document.getElementById('authLinks');
            const ordersIcon = document.getElementById('ordersIcon');

            if (!authLinks) return;

            if (token && user) {
                const userData = JSON.parse(user);
                authLinks.innerHTML = `
                    <span style="font-size: 14px; color: #666; margin-right: 16px;">
                        Hi, ${userData.firstName || userData.name}!
                    </span>
                    <button id="logoutBtn" class="btn btn-primary btn-sm">Logout</button>
                `;

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = '../../index.html';
                });

                if (ordersIcon) ordersIcon.style.display = 'inline-block';
            } else {
                authLinks.innerHTML = `
                    <a href="login.html" class="btn btn-sm" style="background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); margin-right: 8px; text-decoration: none; padding: 8px 16px;">Login</a>
                    <a href="register.html" class="btn btn-primary btn-sm" style="text-decoration: none;">Sign Up</a>
                `;
                if (ordersIcon) ordersIcon.style.display = 'none';
            }
        }

        // Update on storage change
        window.addEventListener('storage', () => {
            updateCartBadge();
            updateAuthUI();
        });

        // Initialize auth
        document.addEventListener('DOMContentLoaded', updateAuthUI);
    </script>
    <script src="../../js/global-auth.js"></script>
</body>

</html>