<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart - TasteNow</title>

    <link rel="stylesheet" href="../../assets/css/base.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/pages.css">

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="../../index.html" class="navbar-brand">
                <i class="fas fa-utensils"></i>
                TasteNow
            </a>

            <button class="navbar-toggle" id="navbarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="navbar-menu" id="navbarMenu">
                <a href="../../index.html" class="navbar-link">Home</a>
                <a href="restaurants.html" class="navbar-link">Restaurants</a>
                <a href="foods.html" class="navbar-link">Foods</a>
            </div>

            <div class="navbar-actions">
                <a href="cart.html" class="navbar-icon active">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="navbar-badge" id="cartBadge">0</span>
                </a>
                <a href="order-history.html" class="navbar-icon" id="ordersIcon" style="display: none;">
                    <i class="fas fa-receipt"></i>
                </a>
                <div id="authLinks">
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="container mt-xl mb-xl">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <div class="breadcrumb-item">
                <a href="../../index.html">Home</a>
            </div>
            <div class="breadcrumb-item">Cart</div>
        </div>

        <h1 class="mb-lg">Shopping Cart</h1>

        <div class="cart-layout">
            <!-- Cart Items -->
            <div class="cart-items">
                <h3 class="mb-lg">Your Items</h3>
                <div id="cartItemsContainer" style="min-height: 200px;">
                    <!-- Cart items will be loaded here by JavaScript -->
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <p>Loading cart items...</p>
                    </div>
                </div>

                <div class="mt-lg">
                    <a href="menu.html" class="btn btn-outline">
                        <i class="fas fa-plus"></i> Add More Items
                    </a>
                </div>
            </div>

                <!-- Cart Summary -->
                <div class="cart-summary">
                    <h3 class="mb-lg">Order Summary</h3>

                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$0.00</span>
                    </div>

                    <div class="summary-row">
                        <span>Delivery Fee</span>
                        <span id="deliveryFee">$3.99</span>
                    </div>

                    <div class="summary-row">
                        <span>Tax (8%)</span>
                        <span id="tax">$0.00</span>
                    </div>

                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">$0.00</span>
                    </div>

                    <div class="mt-lg">
                        <div class="form-group">
                            <label class="form-label">Have a promo code?</label>
                            <div class="d-flex gap-sm">
                                <input type="text" class="form-control" placeholder="Enter code" id="promoCode">
                                <button class="btn btn-secondary" id="applyPromo">Apply</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-lg">
                        <div class="form-group">
                            <label class="form-label">Delivery Address</label>
                            <textarea class="form-control" placeholder="Enter your delivery address" id="deliveryAddress"
                                rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Special Instructions (Optional)</label>
                            <textarea class="form-control" placeholder="Any special requests?" id="specialInstructions" rows="2"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" id="placeOrderBtn">
                        <i class="fas fa-check"></i> Place Order
                    </button>

                    <p class="text-center text-muted mt-md" style="font-size: var(--font-size-sm);">
                        <i class="fas fa-lock"></i> Secure checkout
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TasteNow</h3>
                    <p>Your local food ordering platform.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="#">About Us</a>
                    <a href="#">Contact</a>
                </div>
                <div class="footer-section">
                    <h3>For Restaurants</h3>
                    <a href="#">Partner With Us</a>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> info@tastenow.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TasteNow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../js/main.js"></script>
    <script src="../../js/order.js"></script>
    <script src="../../js/global-auth.js"></script>

    <script>
        const API_URL = 'http://localhost:5000/api';
        const DELIVERY_FEE = 3.99;
        const TAX_RATE = 0.08;

        // Load cart from localStorage
        function loadCart() {
            const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
            console.log('Loaded cart:', cartItems); // Debug log
            return cartItems;
        }

        // Save cart to localStorage
        function saveCart(items) {
            localStorage.setItem('cart', JSON.stringify(items));
            console.log('Saved cart:', items); // Debug log
            renderCart();
        }

        // Render cart items
        function renderCart() {
            console.log('Rendering cart...'); // Debug log
            const cartItems = loadCart();
            const container = document.getElementById('cartItemsContainer');

            if (!container) {
                console.error('Cart container not found!');
                return;
            }

            if (cartItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <p>Your cart is empty</p>
                        <a href="restaurants.html" class="btn btn-primary" style="margin-top: 16px;">Browse Restaurants</a>
                    </div>
                `;
                updateSummary(cartItems);
                return;
            }

            let html = '';
            cartItems.forEach((item, index) => {
                const itemTotal = (item.price * item.quantity).toFixed(2);
                html += `
                    <div class="cart-item">
                        <img src="${item.image || 'https://via.placeholder.com/80?text=Food'}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h4>${item.name}</h4>
                            <p class="text-muted">${item.restaurant}</p>
                            <div class="quantity-selector mt-sm">
                                <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                <span class="quantity-value">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                            </div>
                        </div>
                        <div class="cart-item-actions">
                            <span class="price">$${itemTotal}</span>
                            <button class="btn btn-sm" onclick="removeItem(${index})"
                                style="background-color: var(--danger-color); color: var(--white);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            console.log('Cart rendered with', cartItems.length, 'items'); // Debug log
            updateSummary(cartItems);
        }

        // Update quantity
        function updateQuantity(index, change) {
            const cartItems = loadCart();
            if (cartItems[index]) {
                cartItems[index].quantity += change;
                if (cartItems[index].quantity < 1) {
                    cartItems.splice(index, 1);
                }
                saveCart(cartItems);
            }
        }

        // Remove item
        function removeItem(index) {
            const cartItems = loadCart();
            cartItems.splice(index, 1);
            saveCart(cartItems);
        }

        // Update summary
        function updateSummary(cartItems) {
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + DELIVERY_FEE + tax;

            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('tax').textContent = '$' + tax.toFixed(2);
            document.getElementById('total').textContent = '$' + total.toFixed(2);
            
            // Update badge with total item count
            const badge = document.getElementById('cartBadge');
            if (badge) {
                const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                badge.textContent = totalItems;
            }
        }

        // Place order
        document.getElementById('placeOrderBtn').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login to place an order');
                window.location.href = 'login.html';
                return;
            }

            const cartItems = loadCart();
            if (cartItems.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const specialInstructions = document.getElementById('specialInstructions').value.trim();

            if (!deliveryAddress) {
                alert('Please enter delivery address');
                return;
            }

            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + DELIVERY_FEE + tax;

            const orderData = {
                restaurant_id: cartItems[0].restaurantId || 1,
                delivery_address: deliveryAddress,
                special_instructions: specialInstructions,
                subtotal: subtotal,
                delivery_fee: DELIVERY_FEE,
                tax: tax,
                total_amount: total,
                items: cartItems.map(item => ({
                    item_id: item.id,
                    item_name: item.name,
                    item_price: item.price,
                    quantity: item.quantity,
                    subtotal: item.price * item.quantity
                }))
            };

            try {
                const response = await fetch(`${API_URL}/orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Order placed successfully!');
                    localStorage.removeItem('cart');
                    window.location.href = 'order-history.html';
                } else {
                    alert(data.message || 'Failed to place order');
                }
            } catch (error) {
                alert('Error placing order: ' + error.message);
            }
        });

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderCart);
        } else {
            renderCart();
        }

        // Listen for storage changes (when items added from other pages)
        window.addEventListener('storage', renderCart);

        // Re-render on focus (in case cart was modified in another tab)
        window.addEventListener('focus', renderCart);
    </script>
</body>

</html>