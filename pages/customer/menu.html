<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - TasteNow</title>

    <link rel="stylesheet" href="../../assets/css/base.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/pages.css">

    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="../../index.html" class="navbar-brand">
                <i class="fas fa-utensils"></i>
                TasteNow
            </a>

            <button class="navbar-toggle" id="navbarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="navbar-menu" id="navbarMenu">
                <a href="../../index.html" class="navbar-link">Home</a>
                <a href="restaurants.html" class="navbar-link">Restaurants</a>
                <a href="foods.html" class="navbar-link">Foods</a>
            </div>

            <div class="navbar-actions">
                <a href="cart.html" class="navbar-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="navbar-badge" id="cartBadge">0</span>
                </a>
                <a href="order-history.html" class="navbar-icon" id="ordersIcon" style="display: none;">
                    <i class="fas fa-receipt"></i>
                </a>
                <div id="authLinks">
                    <a href="login.html" class="btn btn-primary btn-sm">Login</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="container mt-xl mb-xl">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <div class="breadcrumb-item">
                <a href="../../index.html">Home</a>
            </div>
            <div class="breadcrumb-item">
                <a href="restaurants.html">Restaurants</a>
            </div>
            <div class="breadcrumb-item" id="restaurantBreadcrumb">Loading...</div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" style="text-align: center; padding: var(--spacing-xl);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
            <p style="margin-top: var(--spacing-md); color: var(--medium-gray);">Loading restaurant menu...</p>
        </div>

        <!-- Restaurant Header -->
        <div class="menu-header" id="restaurantHeader" style="display: none;">
            <div class="menu-restaurant-info">
                <img id="restaurantLogo" src="https://via.placeholder.com/120" alt="Restaurant Logo" class="menu-restaurant-logo">
                <div>
                    <h1 id="restaurantName">Loading...</h1>
                    <div class="rating mb-sm" id="restaurantRating">
                        <i class="fas fa-star rating-star"></i>
                        <span class="text-muted">(Loading...)</span>
                    </div>
                    <p class="text-muted mb-sm" id="restaurantCuisine">Loading...</p>
                    <div class="restaurant-meta" id="restaurantMeta">
                        <div class="restaurant-meta-item">
                            <i class="fas fa-clock"></i>
                            <span id="deliveryTime">Loading...</span>
                        </div>
                        <div class="restaurant-meta-item">
                            <i class="fas fa-bangladeshi-taka-sign"></i>
                            <span id="priceRange">Loading...</span>
                        </div>
                        <div class="restaurant-meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="restaurantAddress">Loading...</span>
                        </div>
                    </div>
                    <span class="badge badge-success mt-sm" id="openStatus">Open Now</span>
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div class="menu-categories" id="categoriesContainer" style="display: none;">
            <div class="category-pill active" data-category="all">All Items</div>
            <!-- Dynamic categories will be added here -->
        </div>

        <!-- Loading state for menu items -->
        <div id="menuItemsLoading" style="text-align: center; padding: var(--spacing-xl); display: none;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
            <p style="margin-top: var(--spacing-md); color: var(--medium-gray);">Loading menu items...</p>
        </div>

        <!-- Menu Items -->
        <div class="grid" style="gap: var(--spacing-md); grid-template-columns: 1fr;" id="menuItemsContainer"></div>
            <!-- Menu items will be dynamically populated -->
        </div>

        <!-- No items message -->
        <div id="noItemsMessage" style="text-align: center; padding: var(--spacing-xl); display: none;">
            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--medium-gray); margin-bottom: var(--spacing-md);"></i>
            <h3 style="color: var(--medium-gray);">No menu items available</h3>
            <p class="text-muted">This restaurant doesn't have any items available right now.</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" style="display: none;">
            <div class="card" style="background-color: #fee; border: 1px solid #fcc;">
                <div class="card-body">
                    <p id="errorText" style="color: #c33; margin: 0;"></p>
                    <button class="btn btn-primary mt-md" onclick="location.href='restaurants.html'">Back to Restaurants</button>
                </div>
            </div>
        </div>

        <!-- Floating Cart Button -->
        <div style="position: fixed; bottom: var(--spacing-xl); right: var(--spacing-xl); z-index: 99; display: none;" id="floatingCart">
            <a href="cart.html" class="btn btn-primary btn-lg"
                style="border-radius: var(--radius-full); box-shadow: var(--shadow-xl);">
                <i class="fas fa-shopping-cart"></i> View Cart (<span id="cartCount">0</span>)
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TasteNow</h3>
                    <p>Your local food ordering platform.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="../../index.html">Home</a>
                    <a href="restaurants.html">Restaurants</a>
                    <a href="foods.html">Foods</a>
                </div>
                <div class="footer-section">
                    <h3>For Restaurants</h3>
                    <a href="#">Partner With Us</a>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> info@tastenow.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 TasteNow. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../js/main.js"></script>
    <script>
        // ==========================================
        // Configuration
        // ==========================================
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentRestaurantId = null;
        let restaurantData = null;
        let menuItems = [];
        let categories = new Set();

        // ==========================================
        // Initialize Page
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Page loaded, starting initialization...');
            console.log('üìç Current URL:', window.location.href);
            console.log('üìç Search params:', window.location.search);
            
            // Ensure error is hidden at start
            hideError();
            
            try {
                // Get restaurant ID from URL
                const params = new URLSearchParams(window.location.search);
                currentRestaurantId = params.get('id');
                
                console.log('üîç Extracted restaurant ID:', currentRestaurantId);

                if (!currentRestaurantId) {
                    console.error('‚ùå No restaurant ID in URL');
                    showError('No restaurant selected. Please go back and select a restaurant.');
                    return;
                }

                console.log('üè™ Loading restaurant ID:', currentRestaurantId);

                // Load restaurant data
                await loadRestaurantData();
                console.log('‚úÖ Restaurant data loaded successfully');

                // Load menu
                await loadRestaurantMenu();
                console.log('‚úÖ Menu loaded successfully');

                // Setup category filters
                setupCategories();

                // Hide loading, show content
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('restaurantHeader').style.display = 'block';
                document.getElementById('categoriesContainer').style.display = 'flex';

                updateCartBadge();
                setupEventListeners();

                console.log('‚úÖ Page initialization complete - no errors');

            } catch (error) {
                console.error('‚ùå Error initializing page:', error);
                console.error('‚ùå Error details:', error.message, error.stack);
                showError('Failed to load restaurant menu. Please try again.');
            }
        });

        // ==========================================
        // Load Restaurant Data
        // ==========================================
        async function loadRestaurantData() {
            try {
                console.log('üìç Fetching restaurant from:', `${API_BASE_URL}/restaurants/${currentRestaurantId}`);

                const response = await fetch(`${API_BASE_URL}/restaurants/${currentRestaurantId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                restaurantData = await response.json();

                console.log('‚úÖ Restaurant data loaded:', restaurantData.name);

                // Populate restaurant header
                populateRestaurantHeader();

            } catch (error) {
                console.error('‚ùå Error loading restaurant data:', error);
                throw error;
            }
        }

        // ==========================================
        // Populate Restaurant Header
        // ==========================================
        function populateRestaurantHeader() {
            if (!restaurantData) return;

            // Update breadcrumb
            document.getElementById('restaurantBreadcrumb').textContent = restaurantData.name;

            // Update header info
            document.getElementById('restaurantName').textContent = restaurantData.name;
            document.getElementById('restaurantCuisine').textContent = restaurantData.cuisine_type || 'Various Cuisines';
            document.getElementById('deliveryTime').textContent = restaurantData.delivery_time || '30-40 min';
            document.getElementById('priceRange').textContent = restaurantData.price_range || '$$';
            document.getElementById('restaurantAddress').textContent = truncateText(restaurantData.address || '', 50);

            // Update status
            const statusBadge = document.getElementById('openStatus');
            if (restaurantData.is_open) {
                statusBadge.textContent = 'Open Now';
                statusBadge.style.backgroundColor = 'var(--success-color)';
            } else {
                statusBadge.textContent = 'Closed';
                statusBadge.style.backgroundColor = 'var(--medium-gray)';
            }

            // Update rating
            const rating = parseFloat(restaurantData.rating) || 4.5;
            const ratingHtml = generateStarRating(rating);
            document.getElementById('restaurantRating').innerHTML = `
                ${ratingHtml}
                <span class="text-muted">(${rating.toFixed(1)}) ‚Ä¢ ${restaurantData.total_reviews || 0}+ ratings</span>
            `;

            // Update logo/image
            const logoImg = document.getElementById('restaurantLogo');
            if (restaurantData.image_url && restaurantData.image_url !== 'null') {
                logoImg.src = restaurantData.image_url;
            } else {
                logoImg.src = 'https://via.placeholder.com/120?text=' + encodeURIComponent(restaurantData.name);
            }

            logoImg.onerror = () => {
                logoImg.src = 'https://via.placeholder.com/120?text=' + encodeURIComponent(restaurantData.name);
            };
        }

        // ==========================================
        // Load Restaurant Menu
        // ==========================================
        async function loadRestaurantMenu() {
            try {
                console.log('üçΩÔ∏è Fetching menu from:', `${API_BASE_URL}/restaurants/${currentRestaurantId}/menu`);

                const response = await fetch(`${API_BASE_URL}/restaurants/${currentRestaurantId}/menu`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('üì¶ API Response:', data);

                if (data.success && Array.isArray(data.items)) {
                    menuItems = data.items;
                    console.log('‚úÖ Using data.items format');
                } else if (Array.isArray(data)) {
                    menuItems = data;
                    console.log('‚úÖ Using array format');
                } else {
                    console.error('‚ùå Invalid data format:', data);
                    throw new Error('Invalid menu data format');
                }

                console.log('‚úÖ Menu items loaded:', menuItems.length);
                console.log('üìã First item:', menuItems[0]);

                // Extract unique categories
                menuItems.forEach(item => {
                    if (item.category_name) {
                        categories.add(item.category_name);
                    }
                });

                console.log('‚úÖ Categories found:', categories.size);

                // Display menu items
                displayMenuItems();

            } catch (error) {
                console.error('‚ùå Error loading menu:', error);
                throw error;
            }
        }

        // ==========================================
        // Setup Category Filters
        // ==========================================
        function setupCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '<div class="category-pill active" data-category="all">All Items</div>';

            Array.from(categories).sort().forEach(category => {
                const pill = document.createElement('div');
                pill.className = 'category-pill';
                pill.setAttribute('data-category', category);
                pill.textContent = category;
                pill.addEventListener('click', function () {
                    filterByCategory(this);
                });
                container.appendChild(pill);
            });

            console.log('‚úÖ Category pills created');
        }

        // ==========================================
        // Display Menu Items
        // ==========================================
        function displayMenuItems() {
            console.log('üé® displayMenuItems called with', menuItems.length, 'items');
            const container = document.getElementById('menuItemsContainer');
            
            if (!container) {
                console.error('‚ùå menuItemsContainer not found!');
                return;
            }
            
            container.innerHTML = '';
            container.style.display = 'grid'; // Ensure container is visible

            if (menuItems.length === 0) {
                console.log('‚ö†Ô∏è No menu items to display');
                container.style.display = 'none';
                document.getElementById('noItemsMessage').style.display = 'block';
                return;
            }

            document.getElementById('noItemsMessage').style.display = 'none';
            console.log('‚úÖ Rendering', menuItems.length, 'menu items');

            menuItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'menu-item-card';
                itemDiv.setAttribute('data-category', item.category_name || 'other');

                const imageUrl = item.image_url && item.image_url !== 'null'
                    ? item.image_url
                    : 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(item.name);

                const vegetarianBadge = item.is_vegetarian
                    ? '<span class="badge badge-success">ü•¨ Vegetarian</span>'
                    : '<span class="badge badge-danger">üçó Non-Veg</span>';

                itemDiv.innerHTML = `
                    <img src="${imageUrl}" alt="${item.name}" class="menu-item-image" onerror="this.src='https://via.placeholder.com/400x300?text=Item'">
                    <div class="menu-item-details">
                        <h3>${item.name}</h3>
                        <p class="menu-item-description">${item.description || 'Delicious food item'}</p>
                        <div class="d-flex gap-sm">
                            ${vegetarianBadge}
                            ${item.preparation_time ? `<span class="badge badge-info">‚è±Ô∏è ${item.preparation_time} mins</span>` : ''}
                            ${!item.is_available ? '<span class="badge badge-warning">Out of Stock</span>' : ''}
                        </div>
                    </div>
                    <div class="menu-item-actions">
                        <span class="price">‡ß≥${parseFloat(item.price).toFixed(2)}</span>
                        <button class="btn btn-primary btn-sm" onclick="addToCart(this, '${item.name}', ${item.item_id}, ${parseFloat(item.price)}, '${imageUrl}')" style="width: 100%; margin-top: 8px;" ${!item.is_available ? 'disabled' : ''}>
                            ${item.is_available ? 'Add to Cart' : 'Unavailable'}
                        </button>
                    </div>
                `;

                container.appendChild(itemDiv);
            });

            console.log('‚úÖ Menu items displayed');
        }

        // ==========================================
        // Filter by Category
        // ==========================================
        function filterByCategory(pill) {
            // Remove active class from all pills
            document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));

            // Add active class to clicked pill
            pill.classList.add('active');

            const category = pill.getAttribute('data-category');
            const menuCards = document.querySelectorAll('.menu-item-card');

            menuCards.forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'grid';
                } else {
                    card.style.display = 'none';
                }
            });

            console.log('üîç Filtered by category:', category);
        }

        // ==========================================
        // Add to Cart
        // ==========================================
        function addToCart(btn, itemName, itemId, price, imageUrl) {
            const quantity = 1;

            const cartItem = {
                id: itemId,
                name: itemName,
                price: price,
                quantity: quantity,
                restaurant: restaurantData.name,
                restaurantId: currentRestaurantId,
                image: imageUrl
            };

            // Load existing cart
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');

            // Check if item already exists
            const existingItem = cart.find(item => item.id === itemId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push(cartItem);
            }

            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));

            // Update cart badge
            updateCartBadge();

            console.log('‚úÖ Added to cart:', itemName);
            alert(`${itemName} added to cart!`);
        }

        // ==========================================
        // Update Cart Badge
        // ==========================================
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

            document.getElementById('cartBadge').textContent = totalItems;
            document.getElementById('cartCount').textContent = totalItems;

            const floatingCart = document.getElementById('floatingCart');
            if (totalItems > 0) {
                floatingCart.style.display = 'block';
            } else {
                floatingCart.style.display = 'none';
            }
        }

        // ==========================================
        // Setup Event Listeners
        // ==========================================
        function setupEventListeners() {
            document.getElementById('navbarToggle')?.addEventListener('click', () => {
                document.getElementById('navbarMenu').classList.toggle('active');
            });

            // Update cart on storage change
            window.addEventListener('storage', updateCartBadge);
        }

        // ==========================================
        // Helper Functions
        // ==========================================
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star rating-star"></i>';
            }

            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt rating-star"></i>';
            }

            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star rating-star"></i>';
            }

            return html;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function showError(message) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('restaurantHeader').style.display = 'none';
            document.getElementById('categoriesContainer').style.display = 'none';
            document.getElementById('menuItemsContainer').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
    </script>
    <script src="../../js/global-auth.js"></script>
</body>

</html>