<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TasteNow - Order Food from Local Restaurants</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/pages.css">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar container">
            <a href="index.html" class="navbar-brand">
                <i class="fas fa-utensils"></i>
                TasteNow
            </a>

            <button class="navbar-toggle" id="navbarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="navbar-menu" id="navbarMenu">
                <a href="index.html" class="navbar-link active">Home</a>
                <a href="pages/customer/restaurants.html" class="navbar-link">Restaurants</a>
                <a href="pages/customer/foods.html" class="navbar-link">Foods</a>
            </div>

            <div class="navbar-actions">
                <a href="pages/customer/cart.html" class="navbar-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="navbar-badge" id="cartBadge">0</span>
                </a>
                <a href="pages/customer/order-history.html" class="navbar-icon" id="ordersIcon" style="display: none;">
                    <i class="fas fa-receipt"></i>
                </a>
                <div id="authLinks">
                    <!-- Auth links will be dynamically updated -->
                </div>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1 class="hero-title">Delicious Food, Delivered Fast</h1>
            <p class="hero-subtitle">Order from your favorite local restaurants</p>

            <div class="hero-search">
                <input type="text" placeholder="Search for restaurants or dishes..." class="form-control"
                    id="heroSearchInput">
                <button class="btn btn-secondary" onclick="searchFromHero()">Search</button>
            </div>
        </div>
    </section>

    <!-- Featured Restaurants -->
    <section class="section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Featured Restaurants</h2>
                <p class="section-subtitle">Discover the best places near you</p>
            </div>

            <div class="grid grid-3" id="restaurantsGrid">
                <!-- Restaurant cards will be dynamically populated from backend -->
            </div>

            <div class="text-center mt-xl">
                <a href="pages/customer/restaurants.html" class="btn btn-outline btn-lg">View All Restaurants</a>
            </div>
        </div>
    </section>

    <!-- Popular Dishes -->
    <section class="section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Popular Dishes</h2>
                <p class="section-subtitle">Trending dishes from top restaurants</p>
            </div>

            <div class="grid grid-4" id="popularDishesGrid">
                <!-- Dish cards will be dynamically populated from backend -->
            </div>

            <div class="text-center mt-xl">
                <a href="pages/customer/foods.html" class="btn btn-outline btn-lg">View All Dishes</a>
            </div>
        </div>
    </section>

    <!-- Newsletter Section -->
    <section class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container">
            <div style="max-width: 600px; margin: 0 auto; text-align: center; color: var(--white);">
                <h2 style="color: var(--white); margin-bottom: var(--spacing-md);">Stay Updated</h2>
                <p style="margin-bottom: var(--spacing-lg);">Subscribe to get exclusive deals and latest restaurant
                    updates delivered to your inbox.</p>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <input type="email" placeholder="Enter your email" class="form-control" id="newsletterEmail"
                        style="flex: 1;">
                    <button class="btn btn-light" onclick="subscribeNewsletter()">Subscribe</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>TasteNow</h3>
                    <p>Your local food ordering platform. Supporting local restaurants and connecting hungry customers.
                    </p>
                </div>

                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <a href="index.html">Home</a>
                    <a href="pages/customer/restaurants.html">Restaurants</a>
                    <a href="pages/customer/about.html">About Us</a>
                    <a href="pages/customer/contact.html">Contact</a>
                </div>

                <div class="footer-section">
                    <h3>For Restaurants</h3>
                    <a href="#">Partner With Us</a>
                    <a href="#">Restaurant Dashboard</a>
                    <a href="#">Terms & Conditions</a>
                </div>

                <div class="footer-section">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> info@tastenow.com</p>
                    <p><i class="fas fa-phone"></i> +1 234 567 8900</p>
                    <p><i class="fas fa-map-marker-alt"></i> 123 Food Street, City</p>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2024 TasteNow. All rights reserved. | Developed by Kaoserahamed</p>
            </div>
        </div>
    </footer>

    <!-- Modal for Food Details -->
    <div class="modal" id="foodModal">
        <div class="modal-dialog" style="max-width: 500px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalFoodName">Food Name</h2>
                    <button class="modal-close" onclick="closeModal('foodModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="modalFoodImage" src="" alt="Food"
                        style="width: 100%; height: 300px; object-fit: cover; border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg);">
                    <div style="margin-bottom: var(--spacing-md);">
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Restaurant:</strong> <span
                                id="modalRestaurant"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Category:</strong> <span
                                id="modalCategory"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Price:</strong> <span
                                id="modalPrice" class="fw-semibold"
                                style="color: var(--primary-color); font-size: 18px;"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Rating:</strong> <span
                                id="modalRating"></span></p>
                        <p style="margin-bottom: 4px; color: var(--medium-gray);"><strong>Type:</strong> <span
                                id="modalType"></span></p>
                    </div>
                    <p id="modalDescription"
                        style="color: var(--dark-gray); line-height: 1.6; margin-bottom: var(--spacing-md);"></p>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                            <button class="btn btn-outline btn-sm" onclick="decreaseQty()">-</button>
                            <input type="number" id="modalQty" class="form-control" value="1" min="1"
                                style="max-width: 80px; text-align: center;">
                            <button class="btn btn-outline btn-sm" onclick="increaseQty()">+</button>
                        </div>
                    </div>
                    <div class="form-actions"
                        style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                        <button class="btn btn-primary btn-block" onclick="addToCart()">Add to Cart</button>
                        <button class="btn btn-outline btn-block" onclick="closeModal('foodModal')">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/main.js"></script>
    <script>
        // Data arrays - To be populated from backend
        let restaurantsData = [];
        let popularDishesData = [];
        let currentSelectedFood = null;

        // Initialize page
        function initHomePage() {
            loadRestaurants();
            loadPopularDishes();
            updateCartBadge();
            updateAuthUI();
        }

        // Load restaurants from backend
        async function loadRestaurants() {
            try {
                const response = await fetch('http://localhost:5000/api/restaurants');
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    // Transform backend data to frontend format
                    restaurantsData = data.map(restaurant => ({
                        id: restaurant.restaurant_id,
                        name: restaurant.name,
                        cuisine: restaurant.cuisine_type,
                        rating: restaurant.rating || 4.5,
                        deliveryTime: restaurant.delivery_time || '30-40',
                        priceRange: restaurant.price_range || '$$',
                        image: restaurant.image_url,
                        isOpen: restaurant.is_open,
                        address: restaurant.address,
                        phone: restaurant.phone
                    }));

                    console.log('‚úÖ Restaurants loaded:', restaurantsData.length);
                    displayRestaurants();
                } else {
                    console.error('Failed to load restaurants:', data);
                    displayRestaurants(); // Show empty state
                }
            } catch (error) {
                console.error('‚ùå Error loading restaurants:', error);
                displayRestaurants(); // Show empty state
            }
        }

        // Load popular dishes from backend
        async function loadPopularDishes() {
            try {
                console.log('üçΩÔ∏è Loading popular dishes from:', 'http://localhost:5000/api/menu/items/public');
                const response = await fetch('http://localhost:5000/api/menu/items/public');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && Array.isArray(data.items)) {
                    popularDishesData = data.items.slice(0, 8);
                } else if (Array.isArray(data)) {
                    popularDishesData = data.slice(0, 8);
                } else {
                    console.warn('‚ö†Ô∏è Unexpected menu items response format:', data);
                    popularDishesData = [];
                }
                
                console.log('‚úÖ Popular dishes loaded:', popularDishesData.length);
                displayPopularDishes();
            } catch (error) {
                console.error('‚ùå Error loading dishes:', error);
                popularDishesData = [];
                displayPopularDishes();
            }
        }

        // Display restaurants
        function displayRestaurants() {
            const grid = document.getElementById('restaurantsGrid');
            grid.innerHTML = '';

            if (restaurantsData.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--medium-gray); padding: var(--spacing-xl);">No restaurants available at the moment. Please check back later!</p>';
                return;
            }

            restaurantsData.forEach(restaurant => {
                const card = document.createElement('div');
                card.className = 'card restaurant-card';
                card.innerHTML = `
                    <div style="position: relative;">
                        <img src="${restaurant.image || 'https://via.placeholder.com/400x300?text=Restaurant'}" alt="${restaurant.name}" class="card-img">
                        <span class="restaurant-badge">${restaurant.isOpen ? 'Open Now' : 'Closed'}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${restaurant.name}</h3>
                        <div class="rating mb-sm">
                            ${generateStarRating(restaurant.rating)}
                            <span class="text-muted">(${restaurant.rating})</span>
                        </div>
                        <p class="card-text">${restaurant.cuisine || 'Various Cuisines'}</p>
                        <div class="restaurant-meta">
                            <div class="restaurant-meta-item">
                                <i class="fas fa-clock"></i>
                                <span>${restaurant.deliveryTime || '30-40'} min</span>
                            </div>
                            <div class="restaurant-meta-item">
                                <i class="fas fa-dollar-sign"></i>
                                <span>${restaurant.priceRange || '$$'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="pages/customer/menu.html?id=${restaurant.id}" class="btn btn-primary btn-block">View Menu</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Generate star rating HTML
        function generateStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';

            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star rating-star"></i>';
            }

            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt rating-star"></i>';
            }

            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star rating-star"></i>';
            }

            return html;
        }

        

        function displayPopularDishes() {
            const grid = document.getElementById('foodsGrid');
            const noResults = document.getElementById('noResults');
            const resultCount = document.getElementById('resultCount');

            if (filteredData.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                resultCount.textContent = '0';
                return;
            }

            noResults.style.display = 'none';
            grid.innerHTML = '';
            resultCount.textContent = filteredData.length;

            filteredData.forEach(food => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                const imageUrl = food.image_url || 'https://via.placeholder.com/400x300?text=' + encodeURIComponent(food.name);
                const restaurant = allRestaurants[food.restaurant_id];
                const restaurantName = restaurant?.name || 'Unknown Restaurant';
                const vegetarianStatus = food.is_vegetarian ? 'ü•¨ Veg' : 'üçó Non-Veg';
                const availabilityBadge = food.is_available ? '' : '<span class="badge" style="background-color: #FF8C00; color: white; margin-left: 4px;">Unavailable</span>';

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${food.name}" class="card-img" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                    <div class="card-body">
                        <h4 class="card-title" style="margin-bottom: 4px;">${food.name}</h4>
                        <p class="text-muted" style="font-size: 14px; margin-bottom: 8px;">${restaurantName}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span class="fw-semibold" style="color: var(--primary-color); font-size: 18px;">$${parseFloat(food.price).toFixed(2)}</span>
                        </div>
                        <span class="badge" style="background-color: ${food.is_vegetarian ? '#51CF66' : '#FF6B6B'}; color: white;">${vegetarianStatus}</span>
                        ${availabilityBadge}
                    </div>
                `;
                card.onclick = () => openFoodModal(food);
                grid.appendChild(card);
            });
        }

        // Open food modal
        function openFoodModal(food) {
            currentSelectedFood = food;

            document.getElementById('modalFoodName').textContent = food.name;
            document.getElementById('modalFoodImage').src = food.image_url || 'https://via.placeholder/400x300?text=Food';
            document.getElementById('modalRestaurant').textContent = food.restaurant || 'Restaurant';
            document.getElementById('modalCategory').textContent = (food.category || 'main-course').replace('-', ' ').toUpperCase();
            document.getElementById('modalPrice').textContent = '$' + food.price.toFixed(2);
            document.getElementById('modalRating').innerHTML = `<i class="fas fa-star" style="color: #FFD700;"></i> ${food.rating}`;
            document.getElementById('modalType').textContent = food.type === 'veg' ? 'Vegetarian' : food.type === 'vegan' ? 'Vegan' : 'Non-Vegetarian';
            document.getElementById('modalDescription').textContent = food.description || 'Delicious food item from our menu.';
            document.getElementById('modalQty').value = 1;

            openModal('foodModal');
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Quantity controls
        function increaseQty() {
            const input = document.getElementById('modalQty');
            input.value = parseInt(input.value) + 1;
        }

        function decreaseQty() {
            const input = document.getElementById('modalQty');
            if (parseInt(input.value) > 1) {
                input.value = parseInt(input.value) - 1;
            }
        }

        // Add to cart
        function addToCart() {
            if (!currentSelectedFood) {
                alert('Error: No food item selected');
                return;
            }

            const qty = parseInt(document.getElementById('modalQty').value);

            const cartItem = {
                id: currentSelectedFood.id,
                name: currentSelectedFood.name,
                price: currentSelectedFood.price,
                quantity: qty,
                restaurant: currentSelectedFood.restaurant || 'Restaurant',
                restaurantId: currentSelectedFood.restaurantId || currentSelectedFood.id,
                image: currentSelectedFood.image || 'https://via.placeholder.com/400x300?text=Food'
            };

            // Load existing cart
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');

            // Check if item already exists
            const existingItem = cart.find(item => item.id === currentSelectedFood.id);
            if (existingItem) {
                existingItem.quantity += qty;
            } else {
                cart.push(cartItem);
            }

            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));

            // Update cart badge
            updateCartBadge();

            // Show success message
            alert(`${currentSelectedFood.name} x${qty} added to cart!`);
            closeModal('foodModal');
        }

        // Search from hero
        function searchFromHero() {
            const searchTerm = document.getElementById('heroSearchInput').value;
            if (searchTerm.trim()) {
                // Redirect to foods page with search query
                window.location.href = `pages/customer/foods.html?search=${encodeURIComponent(searchTerm)}`;
            }
        }

        // Newsletter subscription
        function subscribeNewsletter() {
            const email = document.getElementById('newsletterEmail').value;
            if (email && email.includes('@')) {
                // TODO: Replace with actual API call
                alert('Thank you for subscribing! You will receive updates at ' + email);
                document.getElementById('newsletterEmail').value = '';
            } else {
                alert('Please enter a valid email address');
            }
        }

        // Update cart badge from localStorage
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
            }
        }

        // Simple auth UI updater
        function updateAuthUI() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            const authLinks = document.getElementById('authLinks');
            const ordersIcon = document.getElementById('ordersIcon');

            if (!authLinks) return;

            if (token && user) {
                const userData = JSON.parse(user);
                const firstName = userData.firstName || userData.fullName?.split(' ')[0] || 'User';
                authLinks.innerHTML = `
                    <span style="font-size: 14px; color: #666; margin-right: 16px;">
                        Hi, ${firstName}!
                    </span>
                    <button id="logoutBtn" class="btn btn-primary btn-sm" style="cursor: pointer;">
                        Logout
                    </button>
                `;

                // Add logout event listener
                setTimeout(() => {
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => {
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('user');
                            localStorage.removeItem('cart');
                            window.location.href = 'index.html';
                        });
                    }
                }, 0);

                // Show orders icon when logged in
                if (ordersIcon) {
                    ordersIcon.style.display = 'inline-block';
                }
            } else {
                authLinks.innerHTML = `
                    <a href="pages/customer/login.html" class="btn btn-sm" style="background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); margin-right: 8px; text-decoration: none; padding: 8px 16px; display: inline-block;">Login</a>
                    <a href="pages/customer/register.html" class="btn btn-primary btn-sm" style="text-decoration: none; display: inline-block;">Sign Up</a>
                `;

                // Hide orders icon when not logged in
                if (ordersIcon) {
                    ordersIcon.style.display = 'none';
                }
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                e.target.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        });

        // Navbar toggle
        document.getElementById('navbarToggle')?.addEventListener('click', () => {
            const menu = document.getElementById('navbarMenu');
            menu.classList.toggle('active');
        });

        // Hero search on Enter key
        document.getElementById('heroSearchInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchFromHero();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initHomePage();
        });

        // Update badge when storage changes (for cross-tab sync)
        window.addEventListener('storage', () => {
            updateCartBadge();
            updateAuthUI();
        });
    </script>
    <script src="js/global-auth.js"></script>
</body>

</html>